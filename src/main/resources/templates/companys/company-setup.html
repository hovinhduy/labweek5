<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Company Setup - MyJob</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex align-items-center mb-4">
        <div class="logo">
            <img th:src="@{/images/logo.png}" alt="MyJob" class="me-2" style="width: 40px;">
            MyJob
        </div>

        <!-- Progress Bar -->
        <div class="ms-auto">
            <div class="progress-container">
                <span class="setup-text">Setup Progress</span>
                <div class="progress" style="width: 200px; height: 6px;">
                    <div class="progress-bar" role="progressbar"
                         th:style="'width: ' + ${progress} + '%'"
                         aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Pills -->
    <ul class="nav nav-pills mb-4">
        <li class="nav-item">
            <a class="nav-link" th:classappend="${currentStep == 1 ? 'active' : ''}"
               th:href="@{/company/setup}">Company Info</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${currentStep == 2 ? 'active' : ''}"
               th:href="@{/company-setup/contact}">Contact</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${currentStep == 3 ? 'active' : ''}"
               th:href="@{/company-setup/address}">Address</a>
        </li>
    </ul>

    <!-- Alert Messages -->
    <div th:if="${message}" class="alert" th:classappend="${messageType}" role="alert">
        <span th:text="${message}"></span>
    </div>

    <!-- Form Container -->
    <div class="form-container">
        <!-- Step 1: Company Info Form -->
        <form th:if="${currentStep == 1}"
              th:action="@{/company-setup/company-info}"
              method="post"
              enctype="multipart/form-data"
              th:object="${company}">

            <h5 class="mb-4">Company Logo</h5>
            <div class="row mb-4">
                <div class="col-md-6 mx-auto">
                    <div class="upload-box border rounded p-4 text-center">
                        <div class="upload-content">
                            <input type="file" name="logo" id="logoInput" class="form-control" accept="image/*" onchange="previewImage(this)">
                            <small class="text-muted">A photo larger than 400 pixels work best. Max photo size 5 MB.</small>
                        </div>
                        <!-- Preview container -->
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="preview" src="" alt="Logo Preview" style="max-width: 200px;">
                        </div>
                        <!-- Show current logo if exists -->
                        <div th:if="${company.logoURL}" class="mt-2">
                            <img th:src="${company.logoURL}" alt="Company Logo" style="max-width: 200px;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <input type="text" th:field="*{companyName}" class="form-control" placeholder="Company name" required>
                <div class="text-danger" th:if="${#fields.hasErrors('companyName')}" th:errors="*{companyName}"></div>
            </div>

            <div class="mb-4">
                <input type="url" th:field="*{website}" class="form-control" placeholder="Company Website">
                <div class="text-danger" th:if="${#fields.hasErrors('website')}" th:errors="*{website}"></div>
            </div>

            <div class="mb-4">
                <textarea th:field="*{aboutUs}" class="form-control" rows="4" placeholder="About Us"></textarea>
                <div class="text-danger" th:if="${#fields.hasErrors('aboutUs')}" th:errors="*{aboutUs}"></div>
            </div>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">Save & Next</button>
            </div>
        </form>

        <!-- Step 2: Contact Form -->
        <form th:if="${currentStep == 2}"
              th:action="@{/company-setup/contact}"
              method="post"
              th:object="${company}">

            <div class="mb-4">
                <input type="email" th:field="*{email}" class="form-control" placeholder="Email" required>
                <div class="text-danger" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
            </div>

            <div class="mb-4">
                <div class="input-group">
                    <select class="form-select" style="max-width: 200px;" name="countryCode">
                        <option value="1">🇺🇸 +1</option>
                        <option value="44">🇬🇧 +44</option>
                        <option value="81">🇯🇵 +81</option>
                    </select>
                    <input type="tel" th:field="*{phone}" class="form-control" placeholder="Phone number" required>
                </div>
                <div class="text-danger" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}"></div>
            </div>

            <div class="d-flex justify-content-between">
                <a th:href="@{/company/setup}" class="btn btn-secondary">Previous</a>
                <button type="submit" class="btn btn-primary">Save & Next</button>
            </div>
        </form>

        <!-- Step 3: Address Form -->
        <form th:if="${currentStep == 3}"
              th:action="@{/company-setup/address}"
              method="post"
              th:object="${company}">

            <div class="row mb-4">
                <div class="col-md-4">
                    <input type="text" th:field="*{streetNumber}" class="form-control" placeholder="Number" required>
                    <div class="text-danger" th:if="${#fields.hasErrors('streetNumber')}" th:errors="*{streetNumber}"></div>
                </div>
                <div class="col-md-8">
                    <input type="text" th:field="*{street}" class="form-control" placeholder="Street" required>
                    <div class="text-danger" th:if="${#fields.hasErrors('street')}" th:errors="*{street}"></div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <input type="text" th:field="*{city}" class="form-control" placeholder="City" required>
                    <div class="text-danger" th:if="${#fields.hasErrors('city')}" th:errors="*{city}"></div>
                </div>
                <div class="col-md-6">
                    <input type="text" th:field="*{zipCode}" class="form-control" placeholder="ZIP Code" required>
                    <div class="text-danger" th:if="${#fields.hasErrors('zipCode')}" th:errors="*{zipCode}"></div>
                </div>
            </div>

            <div class="mb-4">
                <select th:field="*{country}" class="form-select" required>
                    <option value="">Select country...</option>
                    <option th:each="country : ${countries}"
                            th:value="${country}"
                            th:text="${country.name}">
                    </option>
                </select>
                <div class="text-danger" th:if="${#fields.hasErrors('country')}" th:errors="*{country}"></div>
            </div>

            <div class="d-flex justify-content-between">
                <a th:href="@{/company-setup/contact}" class="btn btn-secondary">Previous</a>
                <button type="submit" class="btn btn-primary">Finish Setup</button>
            </div>
        </form>
    </div>

    <footer class="mt-4 text-center">
        <small>© 2024 MyJob - Job Portal. All rights Reserved</small>
    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    function previewImage(input) {
        const preview = document.getElementById('preview');
        const previewContainer = document.getElementById('imagePreview');

        if (input.files && input.files[0]) {
            const file = input.files[0];

            // Kiểm tra kích thước file
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                input.value = '';
                return;
            }

            // Kiểm tra loại file
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                input.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                preview.src = e.target.result;
                previewContainer.style.display = 'block';
            }

            reader.readAsDataURL(file);

            // Upload file ngay khi chọn
            uploadImage(file);
        }
    }

    function uploadImage(file) {
        const formData = new FormData();
        formData.append('logo', file);

        fetch('/company-setup/upload-logo', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cập nhật hidden input với URL mới
                    const logoUrlInput = document.createElement('input');
                    logoUrlInput.type = 'hidden';
                    logoUrlInput.name = 'logoURL';
                    logoUrlInput.value = data.url;
                    document.querySelector('form').appendChild(logoUrlInput);
                } else {
                    alert('Upload failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Upload failed');
            });
    }
</script>
</body>
</html>